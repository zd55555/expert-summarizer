<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="AI-powered content analysis with memory">
    
    <title>YouPlus v2: Cognitive Workbench</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiWW91UGx1cyB2MiIsInNob3J0X25hbWUiOiJZb3VQbHVzIiwiZGVzY3JpcHRpb24iOiJBSS1wb3dlcmVkIGNvbnRlbnQgYW5hbHlzaXMgd2l0aCBtZW1vcnkiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2Y5ZmFmYiIsInRoZW1lX2NvbG9yIjoiIzI1NjNlYiIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUIzYVdSMGFEMGlNalFpSUdobGFXZG9kRDBpTWpRaUlIWnBaWGREYjNnOUlqQWdNQ0F5TkNBeU5DSWdabWxzYkQwaUl6STFOak5sWWlJK1BHTnBjbU5zWlNCamVEMGlNVElpSUdONVBTSXhNaUlnY2owaU5pSWdabWxzYkQwaUkyWm1abWtpTHo0OGRHVjRkQ0I0UFNJeE1pSWdlVDBpTVRZdU5TSWdabWxzYkQwaUl6STFOak5sWWlJZ1ptOXVkQzFtWVcxcGJIazlJbTF2Ym05emNHRmpaU0lnWm05dWRDMXphWHBsUFNJeE1DSWdkR1Y0ZEMxaGJtTm9iM0k5SW0xcFpHUnNaU0krUVVrOEwzUmxlSFErUEM5emRtYytQZz09Iiwic2l6ZXMiOiIyNHgyNCIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    
    <!-- Icons -->
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzI1NjNlYiI+PGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iNiIgZmlsbD0iI2ZmZiIvPjx0ZXh0IHg9IjEyIiB5PSIxNi41IiBmaWxsPSIjMjU2M2ViIiBmb250LWZhbWlseT0ibW9ub3NwYWNlIiBmb250LXNpemU9IjEwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5BSTwvdGV4dD48L3N2Zz4=">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 1rem;
            color: #1f2937;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            min-height: calc(100vh - 2rem);
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 1.875rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #6b7280;
            font-size: 1rem;
        }

        .input-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        textarea {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 1rem;
            font-size: 1rem;
            line-height: 1.5;
            resize: vertical;
            min-height: 200px;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        textarea::placeholder {
            color: #9ca3af;
        }

        .choice-section {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            display: none;
        }

        .choice-section.show {
            display: block;
        }

        .choice-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
        }

        .choice-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .choice-btn {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 1rem;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .choice-btn:hover {
            border-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
        }

        .choice-btn-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .choice-btn-desc {
            color: #6b7280;
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .workflow-section {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
            display: none;
        }

        .workflow-section.show {
            display: block;
        }

        .workflow-section h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .query-list {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .query-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            color: #374151;
            font-size: 0.95rem;
        }

        .query-item:last-child {
            margin-bottom: 0;
        }

        .memory-item {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
            color: #374151;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .memory-item.error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
        }

        .submit-btn {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 1rem 2rem;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.3);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .submit-btn.secondary {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        }

        .submit-btn.secondary:hover:not(:disabled) {
            box-shadow: 0 10px 25px -5px rgba(5, 150, 105, 0.3);
        }

        .submit-btn.tertiary {
            background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%);
        }

        .submit-btn.tertiary:hover:not(:disabled) {
            box-shadow: 0 10px 25px -5px rgba(124, 58, 237, 0.3);
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .results-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e5e7eb;
            display: none;
        }

        .results-section.show {
            display: block;
        }

        .results-content {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .memory-creation {
            background: #fef3cd;
            border: 2px solid #fbbf24;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
            display: none;
        }

        .memory-creation.show {
            display: block;
        }

        .memory-creation h4 {
            font-weight: 600;
            margin-bottom: 1rem;
            color: #92400e;
        }

        .memory-bite {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .memory-bite:hover {
            background: #fffbeb;
        }

        .memory-bite input[type="checkbox"] {
            margin-top: 0.125rem;
            width: 1.125rem;
            height: 1.125rem;
        }

        .memory-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            align-items: center;
        }

        .memory-count {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }

        .warning-message {
            background: #fffbeb;
            border: 1px solid #fde68a;
            color: #92400e;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: none;
        }

        .warning-message.show {
            display: block;
        }

        .char-counter {
            text-align: right;
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .copy-btn, .expert-btn, .clear-btn, .memory-btn {
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }

        .copy-btn {
            background: #059669;
            color: white;
        }

        .copy-btn:hover {
            background: #047857;
        }

        .expert-btn {
            background: #7c3aed;
            color: white;
        }

        .expert-btn:hover {
            background: #6d28d9;
        }

        .memory-btn {
            background: #f59e0b;
            color: white;
        }

        .memory-btn:hover {
            background: #d97706;
        }

        .clear-btn {
            background: #6b7280;
            color: white;
            width: 100%;
        }

        .clear-btn:hover {
            background: #4b5563;
        }

        .chat-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .chat-input-row {
            display: flex;
            gap: 0.75rem;
        }

        .chat-input {
            flex: 1;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .chat-btn {
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .chat-btn:hover:not(:disabled) {
            background: #1d4ed8;
        }

        .chat-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
            }

            .container {
                padding: 1.5rem;
                border-radius: 12px;
                min-height: calc(100vh - 1rem);
            }

            .header h1 {
                font-size: 1.5rem;
            }

            textarea {
                min-height: 150px;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            .submit-btn {
                padding: 0.875rem 1.5rem;
                font-size: 1rem;
            }

            .choice-buttons {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .actions {
                gap: 0.5rem;
            }

            .actions:first-of-type {
                margin-bottom: 0.5rem;
            }

            .chat-input-row {
                flex-direction: column;
                gap: 0.5rem;
            }

            .chat-btn {
                width: 100%;
            }
        }

        /* PWA install prompt */
        .install-prompt {
            background: #eff6ff;
            border: 1px solid #dbeafe;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
        }

        .install-prompt.show {
            display: block;
        }

        .install-btn {
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
            margin-left: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="install-prompt" id="installPrompt">
            <span>üì± Install this app on your phone for easier access!</span>
            <button class="install-btn" id="installBtn">Install</button>
        </div>

        <div class="header">
            <h1>üß† YouPlus v2</h1>
            <p>Cognitive Workbench Edition: Transform content into expert insights while building your knowledge graph</p>
        </div>

        <div class="input-section">
            <div class="form-group">
                <label for="content">Your Content</label>
                <textarea 
                    id="content" 
                    placeholder="Paste any content here: meeting transcripts, email drafts, reports, brainstorming notes, research papers, customer feedback, interview notes, or strategic documents."
                    maxlength="15000"
                ></textarea>
                <div class="char-counter">
                    <span id="charCount">0</span> / 15,000 characters
                </div>
            </div>

            <!-- Analysis Choice Section -->
            <div class="choice-section" id="choiceSection">
                <div class="choice-title">Choose Your Analysis Approach:</div>
                <div class="choice-buttons">
                    <button class="choice-btn" id="memoryChoiceBtn">
                        <div class="choice-btn-title">üß† Enhanced with Memory</div>
                        <div class="choice-btn-desc">Search your knowledge graph for relevant context, then provide analysis enriched with your historical insights.</div>
                    </button>
                    <button class="choice-btn" id="quickChoiceBtn">
                        <div class="choice-btn-title">üîç Quick Analysis</div>
                        <div class="choice-btn-desc">Immediate expert analysis without searching historical context. Still offers memory creation afterward.</div>
                    </button>
                </div>
            </div>

            <!-- Query Generation Section -->
            <div class="workflow-section" id="querySection">
                <h3>üìã Generated Research Queries</h3>
                <p style="color: #6b7280; margin-bottom: 1rem;">Claude identified these topics to search in your knowledge graph:</p>
                <div class="query-list" id="queryList"></div>
                <button class="submit-btn secondary" id="searchMemoryBtn">
                    <div class="loading-spinner" id="searchSpinner"></div>
                    <span id="searchBtnText">üîç Search My Memory</span>
                </button>
            </div>

            <!-- Memory Results Section -->
            <div class="workflow-section" id="memorySection">
                <h3>üîç Retrieved Memories</h3>
                <div class="warning-message" id="zepWarning">
                    ‚ö†Ô∏è Zep is currently unavailable. Proceeding with regular analysis.
                </div>
                <div id="memoryList"></div>
                <button class="submit-btn tertiary" id="runAnalysisBtn">
                    <div class="loading-spinner" id="analysisSpinner"></div>
                    <span id="analysisBtnText">üöÄ Run Enhanced Analysis</span>
                </button>
            </div>

            <div class="error-message" id="errorMessage"></div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <h3>üìä Expert Analysis</h3>
            <div id="memoryContext" style="background: #f3e8ff; border-left: 4px solid #8b5cf6; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: none;">
                <h4 style="color: #6b21a8; margin-bottom: 0.5rem;">üîç Memory Context Used</h4>
                <div id="memoryContextList"></div>
            </div>
            <div class="results-content" id="resultsContent"></div>
            <div class="actions">
                <button class="copy-btn" id="copyBtn">üìã Copy Analysis</button>
                <button class="memory-btn" id="memoryBtn">üíæ Generate Memory Bites</button>
            </div>
            <div class="actions">
                <button class="clear-btn" id="clearBtn">üóëÔ∏è New Analysis</button>
            </div>

            <!-- Memory Creation Section -->
            <div class="memory-creation" id="memoryCreation">
                <h4>üíæ Save to Knowledge Graph</h4>
                <p style="color: #92400e; margin-bottom: 1rem;">Select which insights to save to your personal knowledge graph:</p>
                <div id="memoryBitesList"></div>
                <div class="memory-actions">
                    <button class="submit-btn" id="saveMemoriesBtn" style="background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);">
                        <div class="loading-spinner" id="saveSpinner"></div>
                        <span id="saveBtnText">üíæ Save Selected Memories</span>
                    </button>
                    <button class="copy-btn" id="cancelMemoriesBtn" style="background: #6b7280;">Cancel</button>
                    <div class="memory-count" id="memoryCount">0 of 0 memories selected</div>
                </div>
            </div>

            <!-- Chat Section -->
            <div class="chat-section">
                <h4 style="margin-bottom: 0.75rem; color: #374151;">üí¨ Ask the Expert:</h4>
                <div class="chat-input-row">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Ask any question about your content or request a specific deliverable...">
                    <button class="chat-btn" id="chatBtn">
                        <span id="chatBtnText">Ask</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentStep = 'input';
        let useMemory = null;
        let content = '';
        let queries = [];
        let memories = [];
        let analysis = null;
        let memoryBites = [];
        let selectedMemories = new Set();

        // DOM elements
        const contentTextarea = document.getElementById('content');
        const choiceSection = document.getElementById('choiceSection');
        const memoryChoiceBtn = document.getElementById('memoryChoiceBtn');
        const quickChoiceBtn = document.getElementById('quickChoiceBtn');
        const querySection = document.getElementById('querySection');
        const memorySection = document.getElementById('memorySection');
        const resultsSection = document.getElementById('resultsSection');
        const errorMessage = document.getElementById('errorMessage');
        const charCount = document.getElementById('charCount');

        // Initialize
        contentTextarea.addEventListener('input', function() {
            content = this.value;
            const count = content.length;
            charCount.textContent = count;
            
            if (count > 13000) {
                charCount.style.color = '#dc2626';
            } else if (count > 10000) {
                charCount.style.color = '#f59e0b';
            } else {
                charCount.style.color = '#6b7280';
            }

            if (count > 50) {
                choiceSection.classList.add('show');
            } else {
                choiceSection.classList.remove('show');
            }
        });

        // Event listeners
        memoryChoiceBtn.addEventListener('click', () => {
            useMemory = true;
            generateQueries();
        });

        quickChoiceBtn.addEventListener('click', () => {
            useMemory = false;
            analyzeContent(false);
        });

        document.getElementById('searchMemoryBtn').addEventListener('click', handleSearchMemory);
        document.getElementById('runAnalysisBtn').addEventListener('click', () => analyzeContent(true));
        document.getElementById('copyBtn').addEventListener('click', copyToClipboard);
        document.getElementById('memoryBtn').addEventListener('click', generateMemoryBites);
        document.getElementById('clearBtn').addEventListener('click', clearAll);
        document.getElementById('saveMemoriesBtn').addEventListener('click', handleSaveMemories);
        document.getElementById('cancelMemoriesBtn').addEventListener('click', () => {
            document.getElementById('memoryCreation').classList.remove('show');
        });
        document.getElementById('chatBtn').addEventListener('click', handleChatMessage);
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleChatMessage();
        });

        // Placeholder Zep API functions
        async function searchZepMemories(searchQueries) {
            try {
                const response = await fetch('/.netlify/functions/zep-search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ queries: searchQueries })
                });
                
                if (!response.ok) throw new Error('Zep search failed');
                
                const data = await response.json();
                return data.memories || [];
            } catch (err) {
                console.error('Zep search error:', err);
                throw new Error('Zep is currently unavailable');
            }
        }

        async function saveZepMemories(memoriesToSave) {
            try {
                const response = await fetch('/.netlify/functions/zep-save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ memories: memoriesToSave })
                });
                
                if (!response.ok) throw new Error('Zep save failed');
                
                return await response.json();
            } catch (err) {
                console.error('Zep save error:', err);
                throw new Error('Failed to save memories to Zep');
            }
        }

        // Main functions
        async function generateQueries() {
            setLoading('searchMemoryBtn', 'searchSpinner', 'searchBtnText', 'Generating queries...');
            hideError();
            
            const prompt = `You are a research strategist. Analyze this content and generate 3-5 precise questions that should be asked of a personal knowledge database to gather relevant context.

Focus on:
- Key people, organizations, or entities mentioned
- Similar topics, projects, or situations from the past
- Related decisions, outcomes, or lessons learned
- Background context that would inform analysis

Return ONLY a JSON array of query strings, nothing else.

Content to analyze:
${content}`;

            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1000,
                        messages: [{ role: "user", content: prompt }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Query generation failed: ${response.status}`);
                }

                const data = await response.json();
                let responseText = data.content[0].text.trim();
                responseText = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
                
                queries = JSON.parse(responseText);
                displayQueries();
                querySection.classList.add('show');
                currentStep = 'queries';
            } catch (err) {
                handleApiError(err);
            } finally {
                setLoading('searchMemoryBtn', 'searchSpinner', 'searchBtnText', 'üîç Search My Memory', false);
            }
        }

        function displayQueries() {
            const queryList = document.getElementById('queryList');
            queryList.innerHTML = queries.map(query => 
                `<div class="query-item">
                    <span style="color: #059669;">‚Ä¢</span>
                    <span>${query}</span>
                </div>`
            ).join('');
        }

        async function handleSearchMemory() {
            setLoading('searchMemoryBtn', 'searchSpinner', 'searchBtnText', 'Searching...');
            
            try {
                const retrievedMemories = await searchZepMemories(queries);
                
                if (retrievedMemories.length === 0) {
                    memories = ['No relevant memories found in your knowledge graph.'];
                } else {
                    memories = retrievedMemories;
                }
                
                displayMemories();
                memorySection.classList.add('show');
                currentStep = 'memories';
            } catch (err) {
                document.getElementById('zepWarning').classList.add('show');
                memories = ['Zep is currently unavailable. Proceeding with regular analysis.'];
                displayMemories();
                memorySection.classList.add('show');
                currentStep = 'memories';
            } finally {
                setLoading('searchMemoryBtn', 'searchSpinner', 'searchBtnText', 'üîç Search My Memory', false);
            }
        }

        function displayMemories() {
            const memoryList = document.getElementById('memoryList');
            const runBtn = document.getElementById('runAnalysisBtn');
            const runBtnText = document.getElementById('analysisBtnText');
            
            memoryList.innerHTML = memories.map(memory => {
                const isError = memory.includes('No relevant memories') || memory.includes('currently unavailable');
                return `<div class="memory-item ${isError ? 'error' : ''}">${memory}</div>`;
            }).join('');
            
            const hasValidMemories = !memories[0]?.includes('No relevant memories') && !memories[0]?.includes('currently unavailable');
            runBtnText.textContent = hasValidMemories ? 'üöÄ Run Enhanced Analysis' : 'üöÄ Run Regular Analysis';
        }

        async function analyzeContent(includeMemoryContext = false) {
            const btnId = includeMemoryContext ? 'runAnalysisBtn' : 'searchMemoryBtn';
            const spinnerId = includeMemoryContext ? 'analysisSpinner' : 'searchSpinner';
            const textId = includeMemoryContext ? 'analysisBtnText' : 'searchBtnText';
            
            setLoading(btnId, spinnerId, textId, 'Analyzing...');
            hideError();
            
            let contextSection = '';
            if (includeMemoryContext && memories.length > 0 && !memories[0].includes('No relevant memories') && !memories[0].includes('currently unavailable')) {
                contextSection = `\n\nRELEVANT CONTEXT FROM YOUR KNOWLEDGE GRAPH:\n${memories.join('\n')}\n\nUse this context to inform your analysis when relevant, but focus on the current content.`;
            }
            
            const prompt = `You are a Meeting Transcript Expert who transforms raw content into comprehensive professional analysis using a four-phase system.

## INSTRUCTIONS

### Phase 1: Create Content Summary
- Start with 3 sentences maximum stating what type of content this is and key context
- Extract main topics, decisions, and action items using bullet points only
- Identify participant roles, expertise levels, and key contributions (for meetings)
- Note organizational context, constraints, and underlying objectives that emerge
- Document explicit commitments, timelines, and success criteria mentioned
- HARD LIMIT: Keep entire summary under 200 words regardless of input length

### Phase 2: Identify Expert Persona
- Analyze content themes, challenges, and decision points to determine most relevant professional domain
- Consider the content type and context when selecting expert type
- Choose specific expert role(s) that would provide maximum value for this situation
- OUTPUT: One sentence maximum identifying the expert persona(s) you're adopting

### Phase 3: Provide Expert Analysis
- Assume the role of identified expert completely, drawing on professional training and experience
- Identify what was said "between the lines" but not explicitly discussed
- Analyze content effectiveness and decision quality from expert perspective
- Highlight professional insights only a trained expert in that field would recognize
- Recommend domain-specific resources, frameworks, and methodologies
- Suggest strategic questions that would deepen understanding and improve outcomes

### Phase 4: Offer Action Assistance  
- Review specific action items and deliverables identified in previous phases
- Offer numbered options to help complete concrete next steps immediately
- Consider task dependencies and optimal sequencing when presenting options
- Ask minimal clarifying questions about format preferences when needed
- Leverage expert knowledge to suggest appropriate templates and approaches
- Make it easy for users to simply say "do number X" to get started

## OUTPUT FORMAT

Structure every response using this exact format:

## PHASE 1: CONTENT SUMMARY

**CONTENT TYPE & CONTEXT**
[3 sentences maximum stating what type of content this is and key context]

**KEY INFORMATION**
‚Ä¢ [Key point/decision with owner and deadline if applicable]
‚Ä¢ [Key point/decision with owner and deadline if applicable]
‚Ä¢ [Key point/decision with owner and deadline if applicable]

**PARTICIPANT CONTRIBUTIONS** (if applicable)
[Notable insights, concerns, or perspectives from participants]

---

## PHASE 2: EXPERT IDENTIFICATION

[One sentence identifying the expert persona(s) you're adopting for this analysis]

---

## PHASE 3: EXPERT ANALYSIS

*Speaking as [Expert Persona]*

**PROFESSIONAL INSIGHTS**
[What a trained professional would observe that participants missed]

**READING BETWEEN THE LINES**
[Subtext, patterns, or underlying issues only an expert would recognize]

**CRITICAL GAPS**
[Important topics that should have been discussed from expert perspective]

**RECOMMENDED RESOURCES**
[Specific frameworks, tools, methodologies relevant to their situation]

**EXPERT RECOMMENDATIONS**
[Professional next steps beyond what participants would think of]

**STRATEGIC QUESTIONS**
[Probing questions an expert would ask to deepen understanding]

---

## PHASE 4: ACTION ASSISTANCE

*Continuing as [Expert Persona]*

**IMMEDIATE ASSISTANCE OFFERS**
Based on the analysis above, I can help you get started on several tasks right now:

1. **[Specific action item]** - [Brief description with 2-3 format/preference options]
2. **[Specific action item]** - [Brief description with 2-3 format/preference options]  
3. **[Specific action item]** - [Brief description with 2-3 format/preference options]

**EXPERT TOOLS AVAILABLE**
4. **[Expert-specific deliverable]** - [Format options]
5. **[Expert-specific deliverable]** - [Format options]

**READY TO START?**
Just tell me which number you'd like me to work on, and I'll create it immediately.

Take a deep breath and provide thorough, professional analysis that users would find genuinely valuable.

Here is the content to analyze:${contextSection}

${content}`;

            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 4000,
                        messages: [{ role: "user", content: prompt }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Analysis failed: ${response.status}`);
                }

                const data = await response.json();
                analysis = data.content[0].text;
                
                displayAnalysis(includeMemoryContext);
                resultsSection.classList.add('show');
                resultsSection.scrollIntoView({ behavior: 'smooth' });
                currentStep = 'analysis';
            } catch (err) {
                handleApiError(err);
            } finally {
                setLoading(btnId, spinnerId, textId, includeMemoryContext ? 'üöÄ Run Enhanced Analysis' : 'üîç Search My Memory', false);
            }
        }

        function displayAnalysis(usedMemory) {
            const resultsContent = document.getElementById('resultsContent');
            const memoryContext = document.getElementById('memoryContext');
            const memoryContextList = document.getElementById('memoryContextList');

            resultsContent.textContent = analysis;

            // Show memory context if it was used and valid
            if (usedMemory && memories.length > 0 && !memories[0].includes('No relevant memories') && !memories[0].includes('currently unavailable')) {
                memoryContextList.innerHTML = memories.slice(0, 3).map(memory => 
                    `<div style="background: white; padding: 0.75rem; border-radius: 6px; margin: 0.25rem 0; font-size: 0.875rem; color: #374151;">${memory}</div>`
                ).join('');
                memoryContext.style.display = 'block';
            }
        }

        async function generateMemoryBites() {
            setLoading('memoryBtn', null, null, 'üíæ Generating...');
            
            const memoryPrompt = `Based on the entire session so far (the original content, any retrieved context, and the expert analysis), generate a list of concise, factual, memory-friendly statements.

Each statement must be:
- A self-contained fact
- Specific and actionable
- Worth remembering for future reference
- Clear without additional context

Generate 4-7 memory statements and output them as a valid JSON array of strings. Do not add any conversational filler. Output only the JSON array.`;

            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1000,
                        messages: [
                            { role: "user", content: `Original content: ${content}\n\nAnalysis: ${analysis}` },
                            { role: "assistant", content: "I've completed the analysis of your content." },
                            { role: "user", content: memoryPrompt }
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Memory generation failed: ${response.status}`);
                }

                const data = await response.json();
                let responseText = data.content[0].text.trim();
                responseText = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
                
                memoryBites = JSON.parse(responseText);
                selectedMemories = new Set(memoryBites.map((_, index) => index));
                displayMemoryBites();
                document.getElementById('memoryCreation').classList.add('show');
            } catch (err) {
                handleApiError(err);
            } finally {
                setLoading('memoryBtn', null, null, 'üíæ Generate Memory Bites', false);
            }
        }

        function displayMemoryBites() {
            const memoryBitesList = document.getElementById('memoryBitesList');
            const memoryCount = document.getElementById('memoryCount');
            
            memoryBitesList.innerHTML = memoryBites.map((bite, index) => 
                `<label class="memory-bite">
                    <input type="checkbox" ${selectedMemories.has(index) ? 'checked' : ''} 
                           onchange="toggleMemorySelection(${index})">
                    <span>${bite}</span>
                </label>`
            ).join('');
            
            updateMemoryCount();
        }

        function toggleMemorySelection(index) {
            if (selectedMemories.has(index)) {
                selectedMemories.delete(index);
            } else {
                selectedMemories.add(index);
            }
            updateMemoryCount();
        }

        function updateMemoryCount() {
            const memoryCount = document.getElementById('memoryCount');
            const saveBtnText = document.getElementById('saveBtnText');
            const saveBtn = document.getElementById('saveMemoriesBtn');
            
            const selectedCount = selectedMemories.size;
            const totalCount = memoryBites.length;
            
            memoryCount.textContent = `${selectedCount} of ${totalCount} memories selected`;
            saveBtnText.textContent = `üíæ Save ${selectedCount} Selected Memories`;
            saveBtn.disabled = selectedCount === 0;
        }

        async function handleSaveMemories() {
            const memoriesToSave = memoryBites.filter((_, index) => selectedMemories.has(index));
            
            setLoading('saveMemoriesBtn', 'saveSpinner', 'saveBtnText', 'Saving...');
            
            try {
                await saveZepMemories(memoriesToSave);
                
                // Add success message to results
                const successMessage = `\n\n‚úÖ SUCCESS: ${memoriesToSave.length} memories saved to your knowledge graph and will be available for future sessions.`;
                document.getElementById('resultsContent').textContent = analysis + successMessage;
                
                document.getElementById('memoryCreation').classList.remove('show');
            } catch (err) {
                showError(`Error saving memories: ${err.message}`);
            } finally {
                setLoading('saveMemoriesBtn', 'saveSpinner', 'saveBtnText', 'üíæ Save Selected Memories', false);
            }
        }

        async function handleChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const chatMessage = chatInput.value.trim();
            
            if (!chatMessage) return;
            
            setLoading('chatBtn', null, 'chatBtnText', 'Asking...');
            
            const chatPrompt = `Continue as the expert persona from the previous analysis. The user has asked: "${chatMessage}"

Please respond as the expert, using your knowledge of their content context and analysis. Provide helpful, actionable guidance.`;

            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1500,
                        messages: [
                            { role: "user", content: analysis },
                            { role: "assistant", content: "I've completed the analysis of your content." },
                            { role: "user", content: chatPrompt }
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Chat failed: ${response.status}`);
                }

                const data = await response.json();
                const chatResponse = data.content[0].text;
                
                // Add chat response to results
                const chatSection = `\n\nüí¨ QUESTION: ${chatMessage}\n\n${chatResponse}`;
                document.getElementById('resultsContent').textContent = analysis + chatSection;
                
                chatInput.value = '';
            } catch (err) {
                handleApiError(err);
            } finally {
                setLoading('chatBtn', null, 'chatBtnText', 'Ask', false);
            }
        }

        // Utility functions
        function setLoading(btnId, spinnerId, textId, loadingText, loading = true) {
            const btn = document.getElementById(btnId);
            const spinner = spinnerId ? document.getElementById(spinnerId) : null;
            const textEl = textId ? document.getElementById(textId) : null;
            
            btn.disabled = loading;
            if (spinner) spinner.style.display = loading ? 'inline-block' : 'none';
            if (textEl) textEl.textContent = loading ? loadingText : (textEl.textContent.includes('üîç') ? 'üîç Search My Memory' : (textEl.textContent.includes('üöÄ') ? 'üöÄ Run Enhanced Analysis' : textEl.textContent));
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            errorMessage.scrollIntoView({ behavior: 'smooth' });
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        function handleApiError(err) {
            if (err.message.includes('404') || err.message.includes('401') || err.message.includes('403')) {
                showError('Please log into Claude.ai in another tab, then return here and try again.');
            } else {
                showError(`Error: ${err.message}`);
            }
        }

        async function copyToClipboard() {
            try {
                await navigator.clipboard.writeText(document.getElementById('resultsContent').textContent);
                document.getElementById('copyBtn').textContent = '‚úÖ Copied!';
                setTimeout(() => {
                    document.getElementById('copyBtn').textContent = 'üìã Copy Analysis';
                }, 2000);
            } catch (error) {
                console.error('Copy failed:', error);
            }
        }

        function clearAll() {
            // Reset all state
            currentStep = 'input';
            useMemory = null;
            content = '';
            queries = [];
            memories = [];
            analysis = null;
            memoryBites = [];
            selectedMemories = new Set();

            // Clear UI
            contentTextarea.value = '';
            charCount.textContent = '0';
            choiceSection.classList.remove('show');
            querySection.classList.remove('show');
            memorySection.classList.remove('show');
            resultsSection.classList.remove('show');
            document.getElementById('memoryCreation').classList.remove('show');
            document.getElementById('zepWarning').classList.remove('show');
            document.getElementById('memoryContext').style.display = 'none';
            hideError();
            
            contentTextarea.focus();
        }

        // Character counter
        contentTextarea.addEventListener('input', function() {
            const count = this.value.length;
            charCount.textContent = count;
            
            if (count > 13000) {
                charCount.style.color = '#dc2626';
            } else if (count > 10000) {
                charCount.style.color = '#f59e0b';
            } else {
                charCount.style.color = '#6b7280';
            }
        });

        // PWA install prompt
        let deferredPrompt;
        const installPrompt = document.getElementById('installPrompt');
        const installBtn = document.getElementById('installBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installPrompt.classList.add('show');
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    installPrompt.classList.remove('show');
                }
                deferredPrompt = null;
            }
        });

        // Service worker registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZXZlbnQgPT4ge30pOwoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGV2ZW50ID0+IHsKICBldmVudC5yZXNwb25kV2l0aChmZXRjaChldmVudC5yZXF1ZXN0KSk7Cn0pOw==')
                .then(() => console.log('SW registered'))
                .catch(() => console.log('SW registration failed'));
        }

        // Focus textarea on load
        window.addEventListener('load', () => {
            contentTextarea.focus();
        });

        // Handle paste events
        contentTextarea.addEventListener('paste', function() {
            setTimeout(() => {
                this.dispatchEvent(new Event('input'));
            }, 10);
        });

        // Make toggleMemorySelection globally accessible
        window.toggleMemorySelection = toggleMemorySelection;
    </script>
</body>
</html>
